{"ast":null,"code":"import _defineProperty from \"/Users/tonyshen/beacon-pro/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\n\n/**\r\n * DevExtreme (esm/ui/collection/ui.collection_widget.live_update.js)\r\n * Version: 21.2.6\r\n * Build date: Tue Mar 01 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport $ from \"../../core/renderer\";\nimport CollectionWidget from \"./ui.collection_widget.edit\";\nimport { extend } from \"../../core/utils/extend\";\nimport { each } from \"../../core/utils/iterator\";\nimport { update, insert, indexByKey } from \"../../data/array_utils\";\nimport { keysEqual } from \"../../data/utils\";\nimport { when } from \"../../core/utils/deferred\";\nimport { findChanges } from \"../../core/utils/array_compare\";\nimport domAdapter from \"../../core/dom_adapter\";\nimport { noop } from \"../../core/utils/common\";\nvar PRIVATE_KEY_FIELD = \"__dx_key__\";\nexport default CollectionWidget.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      repaintChangesOnly: false\n    });\n  },\n  ctor: function ctor() {\n    var _this = this;\n\n    this.callBase.apply(this, arguments);\n    this._customizeStoreLoadOptions = function (e) {\n      var dataSource = _this._dataSource;\n\n      if (dataSource && !dataSource.isLoaded()) {\n        _this._correctionIndex = 0;\n      }\n\n      if (_this._correctionIndex && e.storeLoadOptions) {\n        e.storeLoadOptions.skip += _this._correctionIndex;\n      }\n    }, this._dataSource && this._dataSource.on(\"customizeStoreLoadOptions\", this._customizeStoreLoadOptions);\n  },\n  reload: function reload() {\n    this._correctionIndex = 0;\n  },\n  _init: function _init() {\n    this.callBase();\n\n    this._refreshItemsCache();\n\n    this._correctionIndex = 0;\n  },\n  _findItemElementByKey: function _findItemElementByKey(key) {\n    var _this2 = this;\n\n    var result = $();\n    var keyExpr = this.key();\n    this.itemElements().each(function (_, item) {\n      var $item = $(item);\n\n      var itemData = _this2._getItemData($item);\n\n      if (keyExpr ? keysEqual(keyExpr, _this2.keyOf(itemData), key) : _this2._isItemEquals(itemData, key)) {\n        result = $item;\n        return false;\n      }\n    });\n    return result;\n  },\n  _dataSourceChangedHandler: function _dataSourceChangedHandler(newItems, e) {\n    if (null !== e && void 0 !== e && e.changes) {\n      this._modifyByChanges(e.changes);\n    } else {\n      this.callBase(newItems, e);\n\n      this._refreshItemsCache();\n    }\n  },\n  _isItemEquals: function _isItemEquals(item1, item2) {\n    if (item1 && item1[PRIVATE_KEY_FIELD]) {\n      item1 = item1.data;\n    }\n\n    try {\n      return JSON.stringify(item1) === JSON.stringify(item2);\n    } catch (e) {\n      return item1 === item2;\n    }\n  },\n  _isItemStrictEquals: function _isItemStrictEquals(item1, item2) {\n    return this._isItemEquals(item1, item2);\n  },\n  _shouldAddNewGroup: function _shouldAddNewGroup(changes, items) {\n    var result = false;\n\n    if (this.option(\"grouped\")) {\n      if (!changes.length) {\n        result = true;\n      }\n\n      each(changes, function (i, change) {\n        if (\"insert\" === change.type) {\n          result = true;\n          each(items, function (_, item) {\n            if (void 0 !== change.data.key && change.data.key === item.key) {\n              result = false;\n              return false;\n            }\n          });\n        }\n      });\n    }\n\n    return result;\n  },\n  _partialRefresh: function _partialRefresh() {\n    var _this3 = this;\n\n    if (this.option(\"repaintChangesOnly\")) {\n      var result = findChanges(this._itemsCache, this._editStrategy.itemsGetter(), function (data) {\n        if (data && void 0 !== data[PRIVATE_KEY_FIELD]) {\n          return data[PRIVATE_KEY_FIELD];\n        }\n\n        return _this3.keyOf(data);\n      }, this._isItemStrictEquals.bind(this));\n\n      if (result && this._itemsCache.length && !this._shouldAddNewGroup(result, this._itemsCache)) {\n        this._modifyByChanges(result, true);\n\n        this._renderEmptyMessage();\n\n        return true;\n      } else {\n        this._refreshItemsCache();\n      }\n    }\n\n    return false;\n  },\n  _refreshItemsCache: function _refreshItemsCache() {\n    if (this.option(\"repaintChangesOnly\")) {\n      var items = this._editStrategy.itemsGetter();\n\n      try {\n        this._itemsCache = extend(true, [], items);\n\n        if (!this.key()) {\n          this._itemsCache = this._itemsCache.map(function (itemCache, index) {\n            var _ref;\n\n            return _ref = {}, _defineProperty(_ref, PRIVATE_KEY_FIELD, items[index]), _defineProperty(_ref, \"data\", itemCache), _ref;\n          });\n        }\n      } catch (e) {\n        this._itemsCache = extend([], items);\n      }\n    }\n  },\n  _dispose: function _dispose() {\n    this._dataSource && this._dataSource.off(\"customizeStoreLoadOptions\", this._customizeStoreLoadOptions);\n    this.callBase();\n  },\n  _updateByChange: function _updateByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this4 = this;\n\n    if (isPartialRefresh) {\n      this._renderItem(change.index, change.data, null, this._findItemElementByKey(change.key));\n    } else {\n      var changedItem = items[indexByKey(keyInfo, items, change.key)];\n\n      if (changedItem) {\n        update(keyInfo, items, change.key, change.data).done(function () {\n          _this4._renderItem(items.indexOf(changedItem), changedItem, null, _this4._findItemElementByKey(change.key));\n        });\n      }\n    }\n  },\n  _insertByChange: function _insertByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this5 = this;\n\n    when(isPartialRefresh || insert(keyInfo, items, change.data, change.index)).done(function () {\n      var _change$index;\n\n      _this5._beforeItemElementInserted(change);\n\n      var $itemContainer = _this5._getItemContainer(change.data);\n\n      _this5._renderItem(null !== (_change$index = change.index) && void 0 !== _change$index ? _change$index : items.length, change.data, $itemContainer);\n\n      _this5._afterItemElementInserted();\n\n      _this5._correctionIndex++;\n    });\n  },\n  _getItemContainer: function _getItemContainer(changeData) {\n    return this._itemContainer();\n  },\n  _updateSelectionAfterRemoveByChange: function _updateSelectionAfterRemoveByChange(removeIndex) {\n    var selectedIndex = this.option(\"selectedIndex\");\n\n    if (selectedIndex > removeIndex) {\n      this.option(\"selectedIndex\", selectedIndex - 1);\n    } else if (selectedIndex === removeIndex && 1 === this.option(\"selectedItems\").length) {\n      this.option(\"selectedItems\", []);\n    } else {\n      this._normalizeSelectedItems();\n    }\n  },\n  _beforeItemElementInserted: function _beforeItemElementInserted(change) {\n    var selectedIndex = this.option(\"selectedIndex\");\n\n    if (change.index <= selectedIndex) {\n      this.option(\"selectedIndex\", selectedIndex + 1);\n    }\n  },\n  _afterItemElementInserted: noop,\n  _removeByChange: function _removeByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this6 = this;\n\n    var index = isPartialRefresh ? change.index : indexByKey(keyInfo, items, change.key);\n    var removedItem = isPartialRefresh ? change.oldItem : items[index];\n\n    if (removedItem) {\n      var $removedItemElement = this._findItemElementByKey(change.key);\n\n      var deletedActionArgs = this._extendActionArgs($removedItemElement);\n\n      this._waitDeletingPrepare($removedItemElement).done(function () {\n        if (isPartialRefresh) {\n          _this6._updateIndicesAfterIndex(index - 1);\n\n          _this6._afterItemElementDeleted($removedItemElement, deletedActionArgs);\n\n          _this6._updateSelectionAfterRemoveByChange(index);\n        } else {\n          _this6._deleteItemElementByIndex(index);\n\n          _this6._afterItemElementDeleted($removedItemElement, deletedActionArgs);\n        }\n      });\n\n      this._correctionIndex--;\n    }\n  },\n  _modifyByChanges: function _modifyByChanges(changes, isPartialRefresh) {\n    var _this7 = this;\n\n    var items = this._editStrategy.itemsGetter();\n\n    var keyInfo = {\n      key: this.key.bind(this),\n      keyOf: this.keyOf.bind(this)\n    };\n    var dataSource = this._dataSource;\n    var paginate = dataSource && dataSource.paginate();\n    var group = dataSource && dataSource.group();\n\n    if (paginate || group) {\n      changes = changes.filter(function (item) {\n        return \"insert\" !== item.type || void 0 !== item.index;\n      });\n    }\n\n    changes.forEach(function (change) {\n      return _this7[\"_\".concat(change.type, \"ByChange\")](keyInfo, items, change, isPartialRefresh);\n    });\n    this._renderedItemsCount = items.length;\n\n    this._refreshItemsCache();\n\n    this._fireContentReadyAction();\n  },\n  _appendItemToContainer: function _appendItemToContainer($container, $itemFrame, index) {\n    var nextSiblingElement = $container.children(this._itemSelector()).get(index);\n    domAdapter.insertElement($container.get(0), $itemFrame.get(0), nextSiblingElement);\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"items\":\n        var isItemsUpdated = this._partialRefresh(args.value);\n\n        if (!isItemsUpdated) {\n          this.callBase(args);\n        }\n\n        break;\n\n      case \"dataSource\":\n        if (!this.option(\"repaintChangesOnly\") || !args.value) {\n          this.option(\"items\", []);\n        }\n\n        this.callBase(args);\n        break;\n\n      case \"repaintChangesOnly\":\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  }\n});","map":null,"metadata":{},"sourceType":"module"}