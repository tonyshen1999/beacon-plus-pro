{"ast":null,"code":"/**\r\n * DevExtreme (esm/viz/core/base_widget.js)\r\n * Version: 21.2.6\r\n * Build date: Tue Mar 01 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport $ from \"../../core/renderer\";\nimport { noop } from \"../../core/utils/common\";\nimport { getWindow, hasWindow } from \"../../core/utils/window\";\nimport domAdapter from \"../../core/dom_adapter\";\nimport { isNumeric, isFunction, isDefined, isObject as _isObject, type } from \"../../core/utils/type\";\nimport { each } from \"../../core/utils/iterator\";\nimport _windowResizeCallbacks from \"../../core/utils/resize_callbacks\";\nimport { extend } from \"../../core/utils/extend\";\nimport { BaseThemeManager } from \"../core/base_theme_manager\";\nimport DOMComponent from \"../../core/dom_component\";\nimport { changes, replaceInherit } from \"./helpers\";\nimport { parseScalar as _parseScalar } from \"./utils\";\nimport warnings from \"./errors_warnings\";\nimport { Renderer } from \"./renderers/renderer\";\nimport { getWidth, getHeight } from \"../../core/utils/size\";\nimport _Layout from \"./layout\";\nimport devices from \"../../core/devices\";\nimport eventsEngine from \"../../events/core/events_engine\";\nimport { when } from \"../../core/utils/deferred\";\nimport { createEventTrigger, createResizeHandler, createIncidentOccurred } from \"./base_widget.utils\";\nvar _floor = Math.floor;\nvar _log = warnings.log;\nvar OPTION_RTL_ENABLED = \"rtlEnabled\";\nvar SIZED_ELEMENT_CLASS = \"dx-sized-element\";\nvar _option = DOMComponent.prototype.option;\n\nfunction getTrue() {\n  return true;\n}\n\nfunction getFalse() {\n  return false;\n}\n\nfunction areCanvasesDifferent(canvas1, canvas2) {\n  return !(canvas1.width === canvas2.width && canvas1.height === canvas2.height && canvas1.left === canvas2.left && canvas1.top === canvas2.top && canvas1.right === canvas2.right && canvas1.bottom === canvas2.bottom);\n}\n\nfunction defaultOnIncidentOccurred(e) {\n  if (!e.component._eventsStrategy.hasEvent(\"incidentOccurred\")) {\n    _log.apply(null, [e.target.id].concat(e.target.args || []));\n  }\n}\n\nfunction pickPositiveValue(values) {\n  return values.reduce(function (result, value) {\n    return value > 0 && !result ? value : result;\n  }, 0);\n}\n\nvar getEmptyComponent = function getEmptyComponent() {\n  var emptyComponentConfig = {\n    _initTemplates: function _initTemplates() {},\n    ctor: function ctor(element, options) {\n      this.callBase(element, options);\n      var sizedElement = domAdapter.createElement(\"div\");\n      var width = options && isNumeric(options.width) ? options.width + \"px\" : \"100%\";\n      var height = options && isNumeric(options.height) ? options.height + \"px\" : this._getDefaultSize().height + \"px\";\n      domAdapter.setStyle(sizedElement, \"width\", width);\n      domAdapter.setStyle(sizedElement, \"height\", height);\n      domAdapter.setClass(sizedElement, SIZED_ELEMENT_CLASS);\n      domAdapter.insertElement(element, sizedElement);\n    }\n  };\n  var EmptyComponent = DOMComponent.inherit(emptyComponentConfig);\n  var originalInherit = EmptyComponent.inherit;\n\n  EmptyComponent.inherit = function (config) {\n    for (var field in config) {\n      if (isFunction(config[field]) && \"_\" !== field.substr(0, 1) && \"option\" !== field || \"_dispose\" === field || \"_optionChanged\" === field) {\n        config[field] = noop;\n      }\n    }\n\n    return originalInherit.call(this, config);\n  };\n\n  return EmptyComponent;\n};\n\nfunction callForEach(functions) {\n  functions.forEach(function (c) {\n    return c();\n  });\n}\n\nvar isServerSide = !hasWindow();\n\nfunction sizeIsValid(value) {\n  return isDefined(value) && value > 0;\n}\n\nvar baseWidget = isServerSide ? getEmptyComponent() : DOMComponent.inherit({\n  _eventsMap: {\n    onIncidentOccurred: {\n      name: \"incidentOccurred\"\n    },\n    onDrawn: {\n      name: \"drawn\"\n    }\n  },\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      onIncidentOccurred: defaultOnIncidentOccurred\n    });\n  },\n  _useLinks: true,\n  _init: function _init() {\n    var that = this;\n\n    that._$element.children(\".\" + SIZED_ELEMENT_CLASS).remove();\n\n    that.callBase.apply(that, arguments);\n    that._changesLocker = 0;\n    that._optionChangedLocker = 0;\n    that._asyncFirstDrawing = true;\n    that._changes = changes();\n\n    that._suspendChanges();\n\n    that._themeManager = that._createThemeManager();\n\n    that._themeManager.setCallback(function () {\n      that._requestChange(that._themeDependentChanges);\n    });\n\n    that._renderElementAttributes();\n\n    that._initRenderer();\n\n    var linkTarget = that._useLinks && that._renderer.root;\n    linkTarget && linkTarget.enableLinks().virtualLink(\"core\").virtualLink(\"peripheral\");\n\n    that._renderVisibilityChange();\n\n    that._attachVisibilityChangeHandlers();\n\n    that._toggleParentsScrollSubscription(this._isVisible());\n\n    that._initEventTrigger();\n\n    that._incidentOccurred = createIncidentOccurred(that.NAME, that._eventTrigger);\n    that._layout = new _Layout();\n    linkTarget && linkTarget.linkAfter(\"core\");\n\n    that._initPlugins();\n\n    that._initCore();\n\n    linkTarget && linkTarget.linkAfter();\n\n    that._change(that._initialChanges);\n  },\n  _createThemeManager: function _createThemeManager() {\n    return new BaseThemeManager(this._getThemeManagerOptions());\n  },\n  _getThemeManagerOptions: function _getThemeManagerOptions() {\n    return {\n      themeSection: this._themeSection,\n      fontFields: this._fontFields\n    };\n  },\n  _initialChanges: [\"LAYOUT\", \"RESIZE_HANDLER\", \"THEME\", \"DISABLED\"],\n  _initPlugins: function _initPlugins() {\n    var that = this;\n    each(that._plugins, function (_, plugin) {\n      plugin.init.call(that);\n    });\n  },\n  _disposePlugins: function _disposePlugins() {\n    var that = this;\n    each(that._plugins.slice().reverse(), function (_, plugin) {\n      plugin.dispose.call(that);\n    });\n  },\n  _change: function _change(codes) {\n    this._changes.add(codes);\n  },\n  _suspendChanges: function _suspendChanges() {\n    ++this._changesLocker;\n  },\n  _resumeChanges: function _resumeChanges() {\n    if (0 === --this._changesLocker && this._changes.count() > 0 && !this._applyingChanges) {\n      this._renderer.lock();\n\n      this._applyingChanges = true;\n\n      this._applyChanges();\n\n      this._changes.reset();\n\n      this._applyingChanges = false;\n\n      this._changesApplied();\n\n      this._renderer.unlock();\n\n      if (this._optionsQueue) {\n        this._applyQueuedOptions();\n      }\n\n      this.resolveItemsDeferred(this._legend ? [this._legend] : []);\n      this._optionChangedLocker++;\n\n      this._notify();\n\n      this._optionChangedLocker--;\n    }\n  },\n  resolveItemsDeferred: function resolveItemsDeferred(items) {\n    this._resolveDeferred(this._getTemplatesItems(items));\n  },\n  _collectTemplatesFromItems: function _collectTemplatesFromItems(items) {\n    return items.reduce(function (prev, i) {\n      return {\n        items: prev.items.concat(i.getTemplatesDef()),\n        groups: prev.groups.concat(i.getTemplatesGroups())\n      };\n    }, {\n      items: [],\n      groups: []\n    });\n  },\n  _getTemplatesItems: function _getTemplatesItems(items) {\n    var elements = this._collectTemplatesFromItems(items);\n\n    var extraItems = this._getExtraTemplatesItems();\n\n    return {\n      items: extraItems.items.concat(elements.items),\n      groups: extraItems.groups.concat(elements.groups),\n      launchRequest: [extraItems.launchRequest],\n      doneRequest: [extraItems.doneRequest]\n    };\n  },\n  _getExtraTemplatesItems: function _getExtraTemplatesItems() {\n    return {\n      items: [],\n      groups: [],\n      launchRequest: function launchRequest() {},\n      doneRequest: function doneRequest() {}\n    };\n  },\n  _resolveDeferred: function _resolveDeferred(_ref) {\n    var items = _ref.items,\n        launchRequest = _ref.launchRequest,\n        doneRequest = _ref.doneRequest,\n        groups = _ref.groups;\n    var that = this;\n\n    that._setGroupsVisibility(groups, \"hidden\");\n\n    if (that._changesApplying) {\n      that._changesApplying = false;\n      callForEach(doneRequest);\n      return;\n    }\n\n    var syncRendering = true;\n    when.apply(that, items).done(function () {\n      if (syncRendering) {\n        that._setGroupsVisibility(groups, \"visible\");\n\n        return;\n      }\n\n      callForEach(launchRequest);\n      that._changesApplying = true;\n      var changes = [\"LAYOUT\", \"FULL_RENDER\"];\n\n      if (that._asyncFirstDrawing) {\n        changes.push(\"FORCE_FIRST_DRAWING\");\n        that._asyncFirstDrawing = false;\n      } else {\n        changes.push(\"FORCE_DRAWING\");\n      }\n\n      that._requestChange(changes);\n\n      that._setGroupsVisibility(groups, \"visible\");\n    });\n    syncRendering = false;\n  },\n  _setGroupsVisibility: function _setGroupsVisibility(groups, visibility) {\n    groups.forEach(function (g) {\n      return g.attr({\n        visibility: visibility\n      });\n    });\n  },\n  _applyQueuedOptions: function _applyQueuedOptions() {\n    var queue = this._optionsQueue;\n    this._optionsQueue = null;\n    this.beginUpdate();\n    each(queue, function (_, action) {\n      action();\n    });\n    this.endUpdate();\n  },\n  _requestChange: function _requestChange(codes) {\n    this._suspendChanges();\n\n    this._change(codes);\n\n    this._resumeChanges();\n  },\n  _applyChanges: function _applyChanges() {\n    var changes = this._changes;\n    var order = this._totalChangesOrder;\n    var i;\n    var ii = order.length;\n\n    for (i = 0; i < ii; ++i) {\n      if (changes.has(order[i])) {\n        this[\"_change_\" + order[i]]();\n      }\n    }\n  },\n  _optionChangesOrder: [\"EVENTS\", \"THEME\", \"RENDERER\", \"RESIZE_HANDLER\"],\n  _layoutChangesOrder: [\"ELEMENT_ATTR\", \"CONTAINER_SIZE\", \"LAYOUT\"],\n  _customChangesOrder: [\"DISABLED\"],\n  _change_EVENTS: function _change_EVENTS() {\n    this._eventTrigger.applyChanges();\n  },\n  _change_THEME: function _change_THEME() {\n    this._setThemeAndRtl();\n  },\n  _change_RENDERER: function _change_RENDERER() {\n    this._setRendererOptions();\n  },\n  _change_RESIZE_HANDLER: function _change_RESIZE_HANDLER() {\n    this._setupResizeHandler();\n  },\n  _change_ELEMENT_ATTR: function _change_ELEMENT_ATTR() {\n    this._renderElementAttributes();\n\n    this._change([\"CONTAINER_SIZE\"]);\n  },\n  _change_CONTAINER_SIZE: function _change_CONTAINER_SIZE() {\n    this._updateSize();\n  },\n  _change_LAYOUT: function _change_LAYOUT() {\n    this._setContentSize();\n  },\n  _change_DISABLED: function _change_DISABLED() {\n    var renderer = this._renderer;\n    var root = renderer.root;\n\n    if (this.option(\"disabled\")) {\n      this._initDisabledState = root.attr(\"pointer-events\");\n      root.attr({\n        \"pointer-events\": \"none\",\n        filter: renderer.getGrayScaleFilter().id\n      });\n    } else if (\"none\" === root.attr(\"pointer-events\")) {\n      root.attr({\n        \"pointer-events\": isDefined(this._initDisabledState) ? this._initDisabledState : null,\n        filter: null\n      });\n    }\n  },\n  _themeDependentChanges: [\"RENDERER\"],\n  _initRenderer: function _initRenderer() {\n    this._canvas = this._calculateCanvas();\n    this._renderer = new Renderer({\n      cssClass: this._rootClassPrefix + \" \" + this._rootClass,\n      pathModified: this.option(\"pathModified\"),\n      container: this._$element[0]\n    });\n\n    this._renderer.resize(this._canvas.width, this._canvas.height);\n  },\n  _disposeRenderer: function _disposeRenderer() {\n    this._renderer.dispose();\n  },\n  _getAnimationOptions: noop,\n  render: function render() {\n    this._requestChange([\"CONTAINER_SIZE\"]);\n\n    var visible = this._isVisible();\n\n    this._toggleParentsScrollSubscription(visible);\n\n    !visible && this._stopCurrentHandling();\n  },\n  _toggleParentsScrollSubscription: function _toggleParentsScrollSubscription(subscribe) {\n    var $parents = $(this._renderer.root.element).parents();\n\n    if (\"generic\" === devices.real().platform) {\n      $parents = $parents.add(getWindow());\n    }\n\n    this._proxiedTargetParentsScrollHandler = this._proxiedTargetParentsScrollHandler || function () {\n      this._stopCurrentHandling();\n    }.bind(this);\n\n    eventsEngine.off($().add(this._$prevRootParents), \"scroll.viz_widgets\", this._proxiedTargetParentsScrollHandler);\n\n    if (subscribe) {\n      eventsEngine.on($parents, \"scroll.viz_widgets\", this._proxiedTargetParentsScrollHandler);\n      this._$prevRootParents = $parents;\n    }\n  },\n  _stopCurrentHandling: noop,\n  _dispose: function _dispose() {\n    var that = this;\n    that.callBase.apply(that, arguments);\n\n    that._toggleParentsScrollSubscription(false);\n\n    that._removeResizeHandler();\n\n    that._layout.dispose();\n\n    that._eventTrigger.dispose();\n\n    that._disposeCore();\n\n    that._disposePlugins();\n\n    that._disposeRenderer();\n\n    that._themeManager.dispose();\n\n    that._themeManager = that._renderer = that._eventTrigger = null;\n  },\n  _initEventTrigger: function _initEventTrigger() {\n    var that = this;\n    that._eventTrigger = createEventTrigger(that._eventsMap, function (name) {\n      return that._createActionByOption(name);\n    });\n  },\n  _calculateCanvas: function _calculateCanvas() {\n    var that = this;\n    var size = that.option(\"size\") || {};\n    var margin = that.option(\"margin\") || {};\n    var defaultCanvas = that._getDefaultSize() || {};\n\n    var getSizeOfSide = function getSizeOfSide(size, side, getter) {\n      if (sizeIsValid(size[side]) || !hasWindow()) {\n        return 0;\n      }\n\n      var elementSize = getter(that._$element);\n      return elementSize <= 1 ? 0 : elementSize;\n    };\n\n    var elementWidth = getSizeOfSide(size, \"width\", function (x) {\n      return getWidth(x);\n    });\n    var elementHeight = getSizeOfSide(size, \"height\", function (x) {\n      return getHeight(x);\n    });\n    var canvas = {\n      width: size.width <= 0 ? 0 : _floor(pickPositiveValue([size.width, elementWidth, defaultCanvas.width])),\n      height: size.height <= 0 ? 0 : _floor(pickPositiveValue([size.height, elementHeight, defaultCanvas.height])),\n      left: pickPositiveValue([margin.left, defaultCanvas.left]),\n      top: pickPositiveValue([margin.top, defaultCanvas.top]),\n      right: pickPositiveValue([margin.right, defaultCanvas.right]),\n      bottom: pickPositiveValue([margin.bottom, defaultCanvas.bottom])\n    };\n\n    if (canvas.width - canvas.left - canvas.right <= 0 || canvas.height - canvas.top - canvas.bottom <= 0) {\n      canvas = {\n        width: 0,\n        height: 0\n      };\n    }\n\n    return canvas;\n  },\n  _updateSize: function _updateSize() {\n    var canvas = this._calculateCanvas();\n\n    this._renderer.fixPlacement();\n\n    if (areCanvasesDifferent(this._canvas, canvas) || this.__forceRender) {\n      this._canvas = canvas;\n\n      this._recreateSizeDependentObjects(true);\n\n      this._renderer.resize(canvas.width, canvas.height);\n\n      this._change([\"LAYOUT\"]);\n    }\n  },\n  _recreateSizeDependentObjects: noop,\n  _getMinSize: function _getMinSize() {\n    return [0, 0];\n  },\n  _getAlignmentRect: noop,\n  _setContentSize: function _setContentSize() {\n    var canvas = this._canvas;\n    var layout = this._layout;\n    var rect = canvas.width > 0 && canvas.height > 0 ? [canvas.left, canvas.top, canvas.width - canvas.right, canvas.height - canvas.bottom] : [0, 0, 0, 0];\n    rect = layout.forward(rect, this._getMinSize());\n    var nextRect = this._applySize(rect) || rect;\n    layout.backward(nextRect, this._getAlignmentRect() || nextRect);\n  },\n  _getOption: function _getOption(name, isScalar) {\n    var theme = this._themeManager.theme(name);\n\n    var option = this.option(name);\n    return isScalar ? void 0 !== option ? option : theme : extend(true, {}, theme, option);\n  },\n  _setupResizeHandler: function _setupResizeHandler() {\n    var that = this;\n\n    var redrawOnResize = _parseScalar(this._getOption(\"redrawOnResize\", true), true);\n\n    if (that._resizeHandler) {\n      that._removeResizeHandler();\n    }\n\n    that._resizeHandler = createResizeHandler(function () {\n      if (redrawOnResize) {\n        that._requestChange([\"CONTAINER_SIZE\"]);\n      } else {\n        that._renderer.fixPlacement();\n      }\n    });\n\n    _windowResizeCallbacks.add(that._resizeHandler);\n  },\n  _removeResizeHandler: function _removeResizeHandler() {\n    if (this._resizeHandler) {\n      _windowResizeCallbacks.remove(this._resizeHandler);\n\n      this._resizeHandler.dispose();\n\n      this._resizeHandler = null;\n    }\n  },\n  _onBeginUpdate: noop,\n  beginUpdate: function beginUpdate() {\n    var that = this;\n\n    if (that._initialized && that._isUpdateAllowed()) {\n      that._onBeginUpdate();\n\n      that._suspendChanges();\n    }\n\n    that.callBase.apply(that, arguments);\n    return that;\n  },\n  endUpdate: function endUpdate() {\n    this.callBase();\n    this._isUpdateAllowed() && this._resumeChanges();\n    return this;\n  },\n  option: function option(name) {\n    var that = this;\n\n    if (that._initialized && that._applyingChanges && (arguments.length > 1 || _isObject(name))) {\n      that._optionsQueue = that._optionsQueue || [];\n\n      that._optionsQueue.push(that._getActionForUpdating(arguments));\n    } else {\n      return _option.apply(that, arguments);\n    }\n  },\n  _getActionForUpdating: function _getActionForUpdating(args) {\n    var that = this;\n    return function () {\n      _option.apply(that, args);\n    };\n  },\n  _clean: noop,\n  _render: noop,\n  _optionChanged: function _optionChanged(arg) {\n    var that = this;\n\n    if (that._optionChangedLocker) {\n      return;\n    }\n\n    var partialChanges = that.getPartialChangeOptionsName(arg);\n    var changes = [];\n\n    if (partialChanges.length > 0) {\n      partialChanges.forEach(function (pc) {\n        return changes.push(that._partialOptionChangesMap[pc]);\n      });\n    } else {\n      changes.push(that._optionChangesMap[arg.name]);\n    }\n\n    changes = changes.filter(function (c) {\n      return !!c;\n    });\n\n    if (that._eventTrigger.change(arg.name)) {\n      that._change([\"EVENTS\"]);\n    } else if (changes.length > 0) {\n      that._change(changes);\n    } else {\n      that.callBase.apply(that, arguments);\n    }\n  },\n  _notify: noop,\n  _changesApplied: noop,\n  _optionChangesMap: {\n    size: \"CONTAINER_SIZE\",\n    margin: \"CONTAINER_SIZE\",\n    redrawOnResize: \"RESIZE_HANDLER\",\n    theme: \"THEME\",\n    rtlEnabled: \"THEME\",\n    encodeHtml: \"THEME\",\n    elementAttr: \"ELEMENT_ATTR\",\n    disabled: \"DISABLED\"\n  },\n  _partialOptionChangesMap: {},\n  _partialOptionChangesPath: {},\n  getPartialChangeOptionsName: function getPartialChangeOptionsName(changedOption) {\n    var that = this;\n    var fullName = changedOption.fullName;\n    var sections = fullName.split(/[.]/);\n    var name = changedOption.name;\n    var value = changedOption.value;\n    var options = this._partialOptionChangesPath[name];\n    var partialChangeOptionsName = [];\n\n    if (options) {\n      if (true === options) {\n        partialChangeOptionsName.push(name);\n      } else {\n        options.forEach(function (op) {\n          fullName.indexOf(op) >= 0 && partialChangeOptionsName.push(op);\n        });\n\n        if (1 === sections.length) {\n          if (\"object\" === type(value)) {\n            that._addOptionsNameForPartialUpdate(value, options, partialChangeOptionsName);\n          } else if (\"array\" === type(value)) {\n            if (value.length > 0 && value.every(function (item) {\n              return that._checkOptionsForPartialUpdate(item, options);\n            })) {\n              value.forEach(function (item) {\n                return that._addOptionsNameForPartialUpdate(item, options, partialChangeOptionsName);\n              });\n            }\n          }\n        }\n      }\n    }\n\n    return partialChangeOptionsName.filter(function (value, index, self) {\n      return self.indexOf(value) === index;\n    });\n  },\n  _checkOptionsForPartialUpdate: function _checkOptionsForPartialUpdate(optionObject, options) {\n    return !Object.keys(optionObject).some(function (key) {\n      return -1 === options.indexOf(key);\n    });\n  },\n  _addOptionsNameForPartialUpdate: function _addOptionsNameForPartialUpdate(optionObject, options, partialChangeOptionsName) {\n    var optionKeys = Object.keys(optionObject);\n\n    if (this._checkOptionsForPartialUpdate(optionObject, options)) {\n      optionKeys.forEach(function (key) {\n        return options.indexOf(key) > -1 && partialChangeOptionsName.push(key);\n      });\n    }\n  },\n  _visibilityChanged: function _visibilityChanged() {\n    this.render();\n  },\n  _setThemeAndRtl: function _setThemeAndRtl() {\n    this._themeManager.setTheme(this.option(\"theme\"), this.option(OPTION_RTL_ENABLED));\n  },\n  _getRendererOptions: function _getRendererOptions() {\n    return {\n      rtl: this.option(OPTION_RTL_ENABLED),\n      encodeHtml: this.option(\"encodeHtml\"),\n      animation: this._getAnimationOptions()\n    };\n  },\n  _setRendererOptions: function _setRendererOptions() {\n    this._renderer.setOptions(this._getRendererOptions());\n  },\n  svg: function svg() {\n    return this._renderer.svg();\n  },\n  getSize: function getSize() {\n    var canvas = this._canvas || {};\n    return {\n      width: canvas.width,\n      height: canvas.height\n    };\n  },\n  isReady: getFalse,\n  _dataIsReady: getTrue,\n  _resetIsReady: function _resetIsReady() {\n    this.isReady = getFalse;\n  },\n  _drawn: function _drawn() {\n    var that = this;\n    that.isReady = getFalse;\n\n    if (that._dataIsReady()) {\n      that._renderer.onEndAnimation(function () {\n        that.isReady = getTrue;\n      });\n    }\n\n    that._eventTrigger(\"drawn\", {});\n  }\n});\nexport default baseWidget;\nreplaceInherit(baseWidget);","map":null,"metadata":{},"sourceType":"module"}