{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/grid_core/ui.grid_core.state_storing.js)\r\n * Version: 21.2.6\r\n * Build date: Tue Mar 01 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport { getKeyHash, equalByValue } from \"../../core/utils/common\";\nimport { isDefined } from \"../../core/utils/type\";\nimport { extend } from \"../../core/utils/extend\";\nimport { StateStoringController } from \"./ui.grid_core.state_storing_core\";\nimport { Deferred } from \"../../core/utils/deferred\";\n\nvar getDataState = function getDataState(that) {\n  var pagerView = that.getView(\"pagerView\");\n  var dataController = that.getController(\"data\");\n  var state = {\n    allowedPageSizes: pagerView ? pagerView.getPageSizes() : void 0,\n    filterPanel: {\n      filterEnabled: that.option(\"filterPanel.filterEnabled\")\n    },\n    filterValue: that.option(\"filterValue\"),\n    focusedRowKey: that.option(\"focusedRowEnabled\") ? that.option(\"focusedRowKey\") : void 0\n  };\n  return extend(state, dataController.getUserState());\n};\n\nvar processLoadState = function processLoadState(that) {\n  var columnsController = that.getController(\"columns\");\n  var selectionController = that.getController(\"selection\");\n  var exportController = that.getController(\"export\");\n  var dataController = that.getController(\"data\");\n\n  if (columnsController) {\n    columnsController.columnsChanged.add(function () {\n      that.updateState({\n        columns: columnsController.getUserState()\n      });\n    });\n  }\n\n  if (selectionController) {\n    selectionController.selectionChanged.add(function (e) {\n      that.updateState({\n        selectedRowKeys: e.selectedRowKeys,\n        selectionFilter: e.selectionFilter\n      });\n    });\n  }\n\n  if (dataController) {\n    that._initialPageSize = that.option(\"paging.pageSize\");\n    that._initialFilterValue = that.option(\"filterValue\");\n    dataController.changed.add(function () {\n      var state = getDataState(that);\n      that.updateState(state);\n    });\n  }\n\n  if (exportController) {\n    exportController.selectionOnlyChanged.add(function () {\n      that.updateState({\n        exportSelectionOnly: exportController.selectionOnly()\n      });\n    });\n  }\n};\n\nvar DEFAULT_FILTER_VALUE = null;\n\nvar getFilterValue = function getFilterValue(that, state) {\n  var filterSyncController = that.getController(\"filterSync\");\n  var columnsController = that.getController(\"columns\");\n  var hasFilterState = state.columns || void 0 !== state.filterValue;\n\n  if (filterSyncController) {\n    if (hasFilterState) {\n      return state.filterValue || filterSyncController.getFilterValueFromColumns(state.columns);\n    } else {\n      return that._initialFilterValue || filterSyncController.getFilterValueFromColumns(columnsController.getColumns());\n    }\n  }\n\n  return DEFAULT_FILTER_VALUE;\n};\n\nexport var stateStoringModule = {\n  defaultOptions: function defaultOptions() {\n    return {\n      stateStoring: {\n        enabled: false,\n        storageKey: null,\n        type: \"localStorage\",\n        customLoad: null,\n        customSave: null,\n        savingTimeout: 2e3\n      }\n    };\n  },\n  controllers: {\n    stateStoring: StateStoringController\n  },\n  extenders: {\n    views: {\n      rowsView: {\n        init: function init() {\n          var that = this;\n          var dataController = that.getController(\"data\");\n          that.callBase();\n          dataController.stateLoaded.add(function () {\n            if (dataController.isLoaded() && !dataController.getDataSource()) {\n              that.setLoading(false);\n              that.renderNoDataText();\n              var columnHeadersView = that.component.getView(\"columnHeadersView\");\n              columnHeadersView && columnHeadersView.render();\n\n              that.component._fireContentReadyAction();\n            }\n          });\n        }\n      }\n    },\n    controllers: {\n      stateStoring: {\n        init: function init() {\n          this.callBase.apply(this, arguments);\n          processLoadState(this);\n        },\n        isLoading: function isLoading() {\n          return this.callBase() || this.getController(\"data\").isStateLoading();\n        },\n        state: function state(_state) {\n          var result = this.callBase.apply(this, arguments);\n\n          if (void 0 !== _state) {\n            this.applyState(extend({}, _state));\n          }\n\n          return result;\n        },\n        updateState: function updateState(state) {\n          if (this.isEnabled()) {\n            var oldState = this.state();\n            var newState = extend({}, oldState, state);\n            var oldStateHash = getKeyHash(oldState);\n            var newStateHash = getKeyHash(newState);\n\n            if (!equalByValue(oldStateHash, newStateHash)) {\n              extend(this._state, state);\n              this.save();\n            }\n          } else {\n            extend(this._state, state);\n          }\n        },\n        applyState: function applyState(state) {\n          var allowedPageSizes = state.allowedPageSizes;\n          var searchText = state.searchText;\n          var selectedRowKeys = state.selectedRowKeys;\n          var selectionFilter = state.selectionFilter;\n          var exportController = this.getController(\"export\");\n          var columnsController = this.getController(\"columns\");\n          var dataController = this.getController(\"data\");\n          var scrollingMode = this.option(\"scrolling.mode\");\n          var isVirtualScrollingMode = \"virtual\" === scrollingMode || \"infinite\" === scrollingMode;\n          var showPageSizeSelector = true === this.option(\"pager.visible\") && this.option(\"pager.showPageSizeSelector\");\n          this.component.beginUpdate();\n\n          if (columnsController) {\n            columnsController.setUserState(state.columns);\n          }\n\n          if (exportController) {\n            exportController.selectionOnly(state.exportSelectionOnly);\n          }\n\n          if (!this.option(\"selection.deferred\")) {\n            this.option(\"selectedRowKeys\", selectedRowKeys || []);\n          }\n\n          this.option(\"selectionFilter\", selectionFilter);\n\n          if (allowedPageSizes && \"auto\" === this.option(\"pager.allowedPageSizes\")) {\n            this.option(\"pager\").allowedPageSizes = allowedPageSizes;\n          }\n\n          if (this.option(\"focusedRowEnabled\")) {\n            this.option(\"focusedRowIndex\", -1);\n            this.option(\"focusedRowKey\", state.focusedRowKey || null);\n          }\n\n          this.component.endUpdate();\n          this.option(\"searchPanel.text\", searchText || \"\");\n          this.option(\"filterValue\", getFilterValue(this, state));\n          this.option(\"filterPanel.filterEnabled\", state.filterPanel ? state.filterPanel.filterEnabled : true);\n          this.option(\"paging.pageIndex\", state.pageIndex || 0);\n          this.option(\"paging.pageSize\", (!isVirtualScrollingMode || showPageSizeSelector) && isDefined(state.pageSize) ? state.pageSize : this._initialPageSize);\n          dataController && dataController.reset();\n        }\n      },\n      columns: {\n        getVisibleColumns: function getVisibleColumns() {\n          var visibleColumns = this.callBase.apply(this, arguments);\n          var stateStoringController = this.getController(\"stateStoring\");\n          return stateStoringController.isEnabled() && !stateStoringController.isLoaded() ? [] : visibleColumns;\n        }\n      },\n      data: {\n        callbackNames: function callbackNames() {\n          return this.callBase().concat([\"stateLoaded\"]);\n        },\n        _refreshDataSource: function _refreshDataSource() {\n          var _this = this;\n\n          var callBase = this.callBase;\n          var stateStoringController = this.getController(\"stateStoring\");\n\n          if (stateStoringController.isEnabled() && !stateStoringController.isLoaded()) {\n            clearTimeout(this._restoreStateTimeoutID);\n            var deferred = new Deferred();\n            this._restoreStateTimeoutID = setTimeout(function () {\n              stateStoringController.load().always(function () {\n                _this._restoreStateTimeoutID = null;\n              }).done(function () {\n                callBase.call(_this);\n\n                _this.stateLoaded.fire();\n\n                deferred.resolve();\n              }).fail(function (error) {\n                _this.stateLoaded.fire();\n\n                _this._handleLoadError(error || \"Unknown error\");\n\n                deferred.reject();\n              });\n            });\n            return deferred.promise();\n          } else if (!this.isStateLoading()) {\n            callBase.call(this);\n          }\n        },\n        isLoading: function isLoading() {\n          var stateStoringController = this.getController(\"stateStoring\");\n          return this.callBase() || stateStoringController.isLoading();\n        },\n        isStateLoading: function isStateLoading() {\n          return isDefined(this._restoreStateTimeoutID);\n        },\n        isLoaded: function isLoaded() {\n          return this.callBase() && !this.isStateLoading();\n        },\n        dispose: function dispose() {\n          clearTimeout(this._restoreStateTimeoutID);\n          this.callBase();\n        }\n      },\n      selection: {\n        _fireSelectionChanged: function _fireSelectionChanged(options) {\n          var stateStoringController = this.getController(\"stateStoring\");\n          var isDeferredSelection = this.option(\"selection.deferred\");\n\n          if (stateStoringController.isLoading() && isDeferredSelection) {\n            return;\n          }\n\n          this.callBase.apply(this, arguments);\n        }\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module"}