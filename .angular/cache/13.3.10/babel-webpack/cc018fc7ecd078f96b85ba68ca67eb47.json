{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/editor/ui.data_expression.js)\r\n * Version: 21.2.6\r\n * Build date: Tue Mar 01 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport variableWrapper from \"../../core/utils/variable_wrapper\";\nimport { compileGetter, toComparable } from \"../../core/utils/data\";\nimport { ensureDefined, noop } from \"../../core/utils/common\";\nimport { isDefined, isObject as isObjectType, isString, isFunction } from \"../../core/utils/type\";\nimport { extend } from \"../../core/utils/extend\";\nimport DataHelperMixin from \"../../data_helper\";\nimport { DataSource } from \"../../data/data_source/data_source\";\nimport ArrayStore from \"../../data/array_store\";\nimport { Deferred } from \"../../core/utils/deferred\";\nvar DataExpressionMixin = extend({}, DataHelperMixin, {\n  _dataExpressionDefaultOptions: function _dataExpressionDefaultOptions() {\n    return {\n      items: [],\n      dataSource: null,\n      itemTemplate: \"item\",\n      value: null,\n      valueExpr: \"this\",\n      displayExpr: void 0\n    };\n  },\n  _initDataExpressions: function _initDataExpressions() {\n    this._compileValueGetter();\n\n    this._compileDisplayGetter();\n\n    this._initDynamicTemplates();\n\n    this._initDataSource();\n\n    this._itemsToDataSource();\n  },\n  _itemsToDataSource: function _itemsToDataSource() {\n    if (!this.option(\"dataSource\")) {\n      this._dataSource = new DataSource({\n        store: new ArrayStore(this.option(\"items\")),\n        pageSize: 0\n      });\n    }\n  },\n  _compileDisplayGetter: function _compileDisplayGetter() {\n    this._displayGetter = compileGetter(this._displayGetterExpr());\n  },\n  _displayGetterExpr: function _displayGetterExpr() {\n    return this.option(\"displayExpr\");\n  },\n  _compileValueGetter: function _compileValueGetter() {\n    this._valueGetter = compileGetter(this._valueGetterExpr());\n  },\n  _valueGetterExpr: function _valueGetterExpr() {\n    return this.option(\"valueExpr\") || \"this\";\n  },\n  _loadValue: function _loadValue(value) {\n    var deferred = new Deferred();\n    value = this._unwrappedValue(value);\n\n    if (!isDefined(value)) {\n      return deferred.reject().promise();\n    }\n\n    this._loadSingle(this._valueGetterExpr(), value).done(function (item) {\n      this._isValueEquals(this._valueGetter(item), value) ? deferred.resolve(item) : deferred.reject();\n    }.bind(this)).fail(function () {\n      deferred.reject();\n    });\n\n    this._loadValueDeferred = deferred;\n    return deferred.promise();\n  },\n  _rejectValueLoading: function _rejectValueLoading() {\n    var _this$_loadValueDefer;\n\n    null === (_this$_loadValueDefer = this._loadValueDeferred) || void 0 === _this$_loadValueDefer ? void 0 : _this$_loadValueDefer.reject({\n      shouldSkipCallback: true\n    });\n  },\n  _getCurrentValue: function _getCurrentValue() {\n    return this.option(\"value\");\n  },\n  _unwrappedValue: function _unwrappedValue(value) {\n    var _value;\n\n    value = null !== (_value = value) && void 0 !== _value ? _value : this._getCurrentValue();\n\n    if (value && this._dataSource && \"this\" === this._valueGetterExpr()) {\n      value = this._getItemKey(value);\n    }\n\n    return variableWrapper.unwrap(value);\n  },\n  _getItemKey: function _getItemKey(value) {\n    var key = this._dataSource.key();\n\n    if (Array.isArray(key)) {\n      var result = {};\n\n      for (var i = 0, n = key.length; i < n; i++) {\n        result[key[i]] = value[key[i]];\n      }\n\n      return result;\n    }\n\n    if (key && \"object\" === typeof value) {\n      value = value[key];\n    }\n\n    return value;\n  },\n  _isValueEquals: function _isValueEquals(value1, value2) {\n    var dataSourceKey = this._dataSource && this._dataSource.key();\n\n    var result = this._compareValues(value1, value2);\n\n    if (!result && dataSourceKey && isDefined(value1) && isDefined(value2)) {\n      if (Array.isArray(dataSourceKey)) {\n        result = this._compareByCompositeKey(value1, value2, dataSourceKey);\n      } else {\n        result = this._compareByKey(value1, value2, dataSourceKey);\n      }\n    }\n\n    return result;\n  },\n  _compareByCompositeKey: function _compareByCompositeKey(value1, value2, key) {\n    var isObject = isObjectType;\n\n    if (!isObject(value1) || !isObject(value2)) {\n      return false;\n    }\n\n    for (var i = 0, n = key.length; i < n; i++) {\n      if (value1[key[i]] !== value2[key[i]]) {\n        return false;\n      }\n    }\n\n    return true;\n  },\n  _compareByKey: function _compareByKey(value1, value2, key) {\n    var unwrapObservable = variableWrapper.unwrap;\n    var valueKey1 = ensureDefined(unwrapObservable(value1[key]), value1);\n    var valueKey2 = ensureDefined(unwrapObservable(value2[key]), value2);\n    return this._compareValues(valueKey1, valueKey2);\n  },\n  _compareValues: function _compareValues(value1, value2) {\n    return toComparable(value1, true) === toComparable(value2, true);\n  },\n  _initDynamicTemplates: noop,\n  _setCollectionWidgetItemTemplate: function _setCollectionWidgetItemTemplate() {\n    this._initDynamicTemplates();\n\n    this._setCollectionWidgetOption(\"itemTemplate\", this.option(\"itemTemplate\"));\n  },\n  _getCollectionKeyExpr: function _getCollectionKeyExpr() {\n    var valueExpr = this.option(\"valueExpr\");\n    var isValueExprField = isString(valueExpr) && \"this\" !== valueExpr || isFunction(valueExpr);\n    return isValueExprField ? valueExpr : null;\n  },\n  _dataExpressionOptionChanged: function _dataExpressionOptionChanged(args) {\n    switch (args.name) {\n      case \"items\":\n        this._itemsToDataSource();\n\n        this._setCollectionWidgetOption(\"items\");\n\n        break;\n\n      case \"dataSource\":\n        this._initDataSource();\n\n        break;\n\n      case \"itemTemplate\":\n        this._setCollectionWidgetItemTemplate();\n\n        break;\n\n      case \"valueExpr\":\n        this._compileValueGetter();\n\n        break;\n\n      case \"displayExpr\":\n        this._compileDisplayGetter();\n\n        this._initDynamicTemplates();\n\n        this._setCollectionWidgetOption(\"displayExpr\");\n\n    }\n  }\n});\nexport default DataExpressionMixin;","map":null,"metadata":{},"sourceType":"module"}