{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/number_box/number_box.base.js)\r\n * Version: 21.2.6\r\n * Build date: Tue Mar 01 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport $ from \"../../core/renderer\";\nimport domAdapter from \"../../core/dom_adapter\";\nimport eventsEngine from \"../../events/core/events_engine\";\nimport { applyServerDecimalSeparator, ensureDefined } from \"../../core/utils/common\";\nimport { isDefined } from \"../../core/utils/type\";\nimport { fitIntoRange, inRange } from \"../../core/utils/math\";\nimport { extend } from \"../../core/utils/extend\";\nimport { inArray } from \"../../core/utils/array\";\nimport devices from \"../../core/devices\";\nimport browser from \"../../core/utils/browser\";\nimport TextEditor from \"../text_box/ui.text_editor\";\nimport { addNamespace, getChar, isCommandKeyPressed, normalizeKeyName } from \"../../events/utils/index\";\nimport SpinButtons from \"./number_box.spins\";\nimport messageLocalization from \"../../localization/message\";\nimport { Deferred } from \"../../core/utils/deferred\";\nvar math = Math;\nvar WIDGET_CLASS = \"dx-numberbox\";\nvar FIREFOX_CONTROL_KEYS = [\"tab\", \"del\", \"backspace\", \"leftArrow\", \"rightArrow\", \"home\", \"end\", \"enter\"];\nvar FORCE_VALUECHANGE_EVENT_NAMESPACE = \"NumberBoxForceValueChange\";\nvar NumberBoxBase = TextEditor.inherit({\n  _supportedKeys: function _supportedKeys() {\n    return extend(this.callBase(), {\n      upArrow: function upArrow(e) {\n        if (!isCommandKeyPressed(e)) {\n          e.preventDefault();\n          e.stopPropagation();\n\n          this._spinUpChangeHandler(e);\n        }\n      },\n      downArrow: function downArrow(e) {\n        if (!isCommandKeyPressed(e)) {\n          e.preventDefault();\n          e.stopPropagation();\n\n          this._spinDownChangeHandler(e);\n        }\n      },\n      enter: function enter() {}\n    });\n  },\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      value: 0,\n      min: void 0,\n      max: void 0,\n      step: 1,\n      showSpinButtons: false,\n      useLargeSpinButtons: true,\n      mode: \"text\",\n      invalidValueMessage: messageLocalization.format(\"dxNumberBox-invalidValueMessage\"),\n      buttons: void 0\n    });\n  },\n  _useTemplates: function _useTemplates() {\n    return false;\n  },\n  _getDefaultButtons: function _getDefaultButtons() {\n    return this.callBase().concat([{\n      name: \"spins\",\n      Ctor: SpinButtons\n    }]);\n  },\n  _isSupportInputMode: function _isSupportInputMode() {\n    var version = parseFloat(browser.version);\n    return browser.chrome && version >= 66 || browser.safari && version >= 12;\n  },\n  _defaultOptionsRules: function _defaultOptionsRules() {\n    return this.callBase().concat([{\n      device: function device() {\n        return devices.real().generic && !devices.isSimulator();\n      },\n      options: {\n        useLargeSpinButtons: false\n      }\n    }, {\n      device: function () {\n        return \"desktop\" !== devices.real().deviceType && !this._isSupportInputMode();\n      }.bind(this),\n      options: {\n        mode: \"number\"\n      }\n    }]);\n  },\n  _initMarkup: function _initMarkup() {\n    this._renderSubmitElement();\n\n    this.$element().addClass(WIDGET_CLASS);\n    this.callBase();\n  },\n  _getDefaultAttributes: function _getDefaultAttributes() {\n    var attributes = this.callBase();\n    attributes.inputmode = \"decimal\";\n    return attributes;\n  },\n  _renderContentImpl: function _renderContentImpl() {\n    this.option(\"isValid\") && this._validateValue(this.option(\"value\"));\n    this.setAria(\"role\", \"spinbutton\");\n  },\n  _renderSubmitElement: function _renderSubmitElement() {\n    this._$submitElement = $(\"<input>\").attr(\"type\", \"hidden\").appendTo(this.$element());\n\n    this._setSubmitValue(this.option(\"value\"));\n  },\n  _setSubmitValue: function _setSubmitValue(value) {\n    this._getSubmitElement().val(applyServerDecimalSeparator(value));\n  },\n  _getSubmitElement: function _getSubmitElement() {\n    return this._$submitElement;\n  },\n  _keyPressHandler: function _keyPressHandler(e) {\n    this.callBase(e);\n    var char = getChar(e);\n    var isInputCharValid = /[\\d.,eE\\-+]/.test(char);\n\n    if (!isInputCharValid) {\n      var keyName = normalizeKeyName(e);\n\n      if (isCommandKeyPressed(e) || keyName && inArray(keyName, FIREFOX_CONTROL_KEYS) >= 0) {\n        return;\n      }\n\n      e.preventDefault();\n      return false;\n    }\n\n    this._keyPressed = true;\n  },\n  _onMouseWheel: function _onMouseWheel(dxEvent) {\n    dxEvent.delta > 0 ? this._spinValueChange(1, dxEvent) : this._spinValueChange(-1, dxEvent);\n  },\n  _renderValue: function _renderValue() {\n    var inputValue = this._input().val();\n\n    var value = this.option(\"value\");\n\n    if (!inputValue.length || Number(inputValue) !== value) {\n      this._forceValueRender();\n\n      this._toggleEmptinessEventHandler();\n    }\n\n    var valueText = isDefined(value) ? null : messageLocalization.format(\"dxNumberBox-noDataText\");\n    this.setAria({\n      valuenow: ensureDefined(value, \"\"),\n      valuetext: valueText\n    });\n    this.option(\"text\", this._input().val());\n\n    this._updateButtons();\n\n    return new Deferred().resolve();\n  },\n  _forceValueRender: function _forceValueRender() {\n    var value = this.option(\"value\");\n    var number = Number(value);\n    var formattedValue = isNaN(number) ? \"\" : this._applyDisplayValueFormatter(value);\n\n    this._renderDisplayText(formattedValue);\n  },\n  _applyDisplayValueFormatter: function _applyDisplayValueFormatter(value) {\n    return this.option(\"displayValueFormatter\")(value);\n  },\n  _renderProps: function _renderProps() {\n    this.callBase();\n\n    this._input().prop({\n      min: this.option(\"min\"),\n      max: this.option(\"max\"),\n      step: this.option(\"step\")\n    });\n\n    this.setAria({\n      valuemin: ensureDefined(this.option(\"min\"), \"\"),\n      valuemax: ensureDefined(this.option(\"max\"), \"\")\n    });\n  },\n  _spinButtonsPointerDownHandler: function _spinButtonsPointerDownHandler() {\n    var $input = this._input();\n\n    if (!this.option(\"useLargeSpinButtons\") && domAdapter.getActiveElement() !== $input[0]) {\n      eventsEngine.trigger($input, \"focus\");\n    }\n  },\n  _spinUpChangeHandler: function _spinUpChangeHandler(e) {\n    if (!this.option(\"readOnly\")) {\n      this._spinValueChange(1, e.event || e);\n    }\n  },\n  _spinDownChangeHandler: function _spinDownChangeHandler(e) {\n    if (!this.option(\"readOnly\")) {\n      this._spinValueChange(-1, e.event || e);\n    }\n  },\n  _spinValueChange: function _spinValueChange(sign, dxEvent) {\n    var step = parseFloat(this.option(\"step\"));\n\n    if (0 === step) {\n      return;\n    }\n\n    var value = parseFloat(this._normalizeInputValue()) || 0;\n    value = this._correctRounding(value, step * sign);\n    var min = this.option(\"min\");\n    var max = this.option(\"max\");\n\n    if (isDefined(min)) {\n      value = Math.max(min, value);\n    }\n\n    if (isDefined(max)) {\n      value = Math.min(max, value);\n    }\n\n    this._saveValueChangeEvent(dxEvent);\n\n    this.option(\"value\", value);\n  },\n  _correctRounding: function _correctRounding(value, step) {\n    var regex = /[,.](.*)/;\n    var isFloatValue = regex.test(value);\n    var isFloatStep = regex.test(step);\n\n    if (isFloatValue || isFloatStep) {\n      var valueAccuracy = isFloatValue ? regex.exec(value)[0].length : 0;\n      var stepAccuracy = isFloatStep ? regex.exec(step)[0].length : 0;\n      var accuracy = math.max(valueAccuracy, stepAccuracy);\n      value = this._round(value + step, accuracy);\n      return value;\n    }\n\n    return value + step;\n  },\n  _round: function _round(value, precision) {\n    precision = precision || 0;\n    var multiplier = Math.pow(10, precision);\n    value *= multiplier;\n    value = Math.round(value) / multiplier;\n    return value;\n  },\n  _renderValueChangeEvent: function _renderValueChangeEvent() {\n    this.callBase();\n    var forceValueChangeEvent = addNamespace(\"focusout\", FORCE_VALUECHANGE_EVENT_NAMESPACE);\n    eventsEngine.off(this.element(), forceValueChangeEvent);\n    eventsEngine.on(this.element(), forceValueChangeEvent, this._forceRefreshInputValue.bind(this));\n  },\n  _forceRefreshInputValue: function _forceRefreshInputValue() {\n    if (\"number\" === this.option(\"mode\")) {\n      return;\n    }\n\n    var $input = this._input();\n\n    var formattedValue = this._applyDisplayValueFormatter(this.option(\"value\"));\n\n    $input.val(null);\n    $input.val(formattedValue);\n  },\n  _valueChangeEventHandler: function _valueChangeEventHandler(e) {\n    var $input = this._input();\n\n    var inputValue = this._normalizeText();\n\n    var value = this._parseValue(inputValue);\n\n    var valueHasDigits = \".\" !== inputValue && \"-\" !== inputValue;\n\n    if (this._isValueValid() && !this._validateValue(value)) {\n      $input.val(this._applyDisplayValueFormatter(value));\n      return;\n    }\n\n    if (valueHasDigits) {\n      this.callBase(e, isNaN(value) ? null : value);\n    }\n\n    this._applyValueBoundaries(inputValue, value);\n\n    this.validationRequest.fire({\n      value: value,\n      editor: this\n    });\n  },\n  _applyValueBoundaries: function _applyValueBoundaries(inputValue, parsedValue) {\n    var isValueIncomplete = this._isValueIncomplete(inputValue);\n\n    var isValueCorrect = this._isValueInRange(inputValue);\n\n    if (!isValueIncomplete && !isValueCorrect && null !== parsedValue) {\n      if (Number(inputValue) !== parsedValue) {\n        this._input().val(this._applyDisplayValueFormatter(parsedValue));\n      }\n    }\n  },\n  _replaceCommaWithPoint: function _replaceCommaWithPoint(value) {\n    return value.replace(\",\", \".\");\n  },\n  _inputIsInvalid: function _inputIsInvalid() {\n    var isNumberMode = \"number\" === this.option(\"mode\");\n\n    var validityState = this._input().get(0).validity;\n\n    return isNumberMode && validityState && validityState.badInput;\n  },\n  _renderDisplayText: function _renderDisplayText(text) {\n    if (this._inputIsInvalid()) {\n      return;\n    }\n\n    this.callBase(text);\n  },\n  _isValueIncomplete: function _isValueIncomplete(value) {\n    return /(^-$)|(^-?\\d*\\.$)|(\\d+e-?$)/i.test(value);\n  },\n  _isValueInRange: function _isValueInRange(value) {\n    return inRange(value, this.option(\"min\"), this.option(\"max\"));\n  },\n  _isNumber: function _isNumber(value) {\n    return null !== this._parseValue(value);\n  },\n  _validateValue: function _validateValue(value) {\n    var inputValue = this._normalizeText();\n\n    var isValueValid = this._isValueValid();\n\n    var isValid = true;\n\n    var isNumber = this._isNumber(inputValue);\n\n    if (isNaN(Number(value))) {\n      isValid = false;\n    }\n\n    if (!value && isValueValid) {\n      isValid = true;\n    } else if (!isNumber && !isValueValid) {\n      isValid = false;\n    }\n\n    this.option({\n      isValid: isValid,\n      validationError: isValid ? null : {\n        editorSpecific: true,\n        message: this.option(\"invalidValueMessage\")\n      }\n    });\n    return isValid;\n  },\n  _normalizeInputValue: function _normalizeInputValue() {\n    return this._parseValue(this._normalizeText());\n  },\n  _normalizeText: function _normalizeText() {\n    var value = this._input().val().trim();\n\n    return this._replaceCommaWithPoint(value);\n  },\n  _parseValue: function _parseValue(value) {\n    var number = parseFloat(value);\n\n    if (isNaN(number)) {\n      return null;\n    }\n\n    return fitIntoRange(number, this.option(\"min\"), this.option(\"max\"));\n  },\n  _clearValue: function _clearValue() {\n    if (this._inputIsInvalid()) {\n      this._input().val(\"\");\n\n      this._validateValue();\n    }\n\n    this.callBase();\n  },\n  reset: function reset() {\n    if (null === this.option(\"value\")) {\n      this.option(\"text\", \"\");\n\n      this._renderValue();\n    } else {\n      this.option(\"value\", null);\n    }\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"value\":\n        this._validateValue(args.value);\n\n        this._setSubmitValue(args.value);\n\n        this.callBase(args);\n\n        this._resumeValueChangeAction();\n\n        break;\n\n      case \"step\":\n        this._renderProps();\n\n        break;\n\n      case \"min\":\n      case \"max\":\n        this._renderProps();\n\n        this.option(\"value\", this._parseValue(this.option(\"value\")));\n        break;\n\n      case \"showSpinButtons\":\n      case \"useLargeSpinButtons\":\n        this._updateButtons([\"spins\"]);\n\n        break;\n\n      case \"invalidValueMessage\":\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  }\n});\nexport default NumberBoxBase;","map":null,"metadata":{},"sourceType":"module"}